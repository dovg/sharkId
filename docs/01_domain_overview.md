# Система учета и идентификации тигровых акул — предметная область

## Контекст

Подводный биолог ежедневно выполняет несколько погружений и фотографирует тигровых акул.
Каждая акула имеет уникальный рисунок пятен около морды, по которому можно отличать особей.

Система предназначена для:

- ведения каталога акул,
- автоматической идентификации особей по фото,
- хранения фотоархива и видеозаписей,
- ведения журнала наблюдений,
- группировки наблюдений по погружениям,
- управления справочником локаций,
- ведения журнала действий (audit log).

Автоклассификация выполняется автоматически, но итоговое решение **всегда подтверждается пользователем**.

Авторизация обязательна. Реализована простая ролевая модель с тремя уровнями доступа.

---

## Поддерживаемые форматы

**Изображения:** image/jpeg, image/png (макс. 50 МБ)
**Видео:** MP4, MOV, AVI, MKV, WebM (макс. 500 МБ)

Другие форматы отклоняются при загрузке.

---

## Ролевая модель

| Роль | Доступ |
|------|--------|
| **viewer** | Только чтение; без очереди валидации и журнала событий |
| **editor** | Всё, что viewer + все операции записи |
| **admin** | Всё, что editor + управление пользователями |

Существующие пользователи получают роль `editor` по умолчанию. Новые пользователи создаются с ролью `viewer` (администратор меняет при необходимости).

---

## Основные сущности предметной области

### 1. User (Пользователь)

Поля:
- id
- email
- password_hash
- role (`viewer` | `editor` | `admin`)
- created_at

---

### 2. Shark (Акула)

Каталожная сущность — идентифицированная особь.

Поля:
- id
- display_name
- name_status (`temporary` | `confirmed`)
- created_at
- main_photo_id (FK → Photo)
- main_photo_url (вычисляется при отдаче)

Особенности:
- При создании новой акулы система предлагает временное имя из списка женских персонажей Гарри Поттера.
- Пользователь может принять имя или заменить вручную.
- Имя может оставаться временным.

---

### 3. Photo (Фото)

Фото загружается в привязке к погружению.

Поля:
- id
- object_key (ключ объекта в MinIO)
- content_type, size
- uploaded_at
- exif_payload (JSON, сохраняем всё)
- taken_at, gps_lat, gps_lon (нормализовано из EXIF)
- processing_status
- shark_bbox, zone_bbox (нормализованные {x,y,w,h} 0–1)
- orientation (`face_left` | `face_right`)
- auto_detected (True — bbox выставлен ML, ожидает подтверждения)
- top5_candidates (JSON-массив {shark_id, display_name, score})
- shark_id (FK → Shark, после валидации)
- is_profile_photo

Статусы обработки:
- `uploaded` → `processing` → `ready_for_validation` | `error` | `validated`

---

### 4. DiveSession (Погружение)

Группирует фото, видео и наблюдения.

Поля:
- id
- started_at, ended_at
- location_id
- comment

Ответ API дополнительно включает: shark_count, queue_count, shark_thumbs.

---

### 5. Observation (Наблюдение)

Запись журнала встречи акулы. Создаётся автоматически как черновик при валидации фото.

Поля:
- id
- dive_session_id
- shark_id
- photo_id
- taken_at, location_id, comment
- confirmed_at (NULL → черновик; не NULL → подтверждено, необратимо)

Правила:
- Подтверждение пользователем требуется всегда.
- Подтверждённое наблюдение нельзя редактировать (API возвращает 409).
- exif_payload инжектируется из связанного фото при GET.

---

### 6. Location (Локация)

Справочник мест погружений.

Поля:
- id
- country, spot_name
- lat, lon (валидируются через Field bounds)
- created_at

---

### 7. Video (Видео)

Загружаемая видеозапись погружения.

Поля:
- id
- object_key, content_type, size
- uploaded_at
- processing_status (`uploaded` | `processing` | `done` | `error`)
- frames_extracted
- dive_session_id

При обработке ML-сервис извлекает кадры с акулами, создаёт Photo-записи и запускает классификацию.

---

### 8. AuditLog (Журнал событий)

Фиксирует все изменяющие действия пользователей.

Поля:
- id
- user_id (FK → User, nullable)
- user_email (денормализовано, переживает удаление пользователя)
- action (строка вида `photo.upload`, `session.create` и т.п.)
- resource_type, resource_id
- detail (JSON-контекст)
- ip_address
- created_at

Доступен только пользователям с ролью editor и выше.

---

## Резервное копирование

- Регулярный дамп PostgreSQL обязателен.
- Регулярный snapshot MinIO обязателен.
- Процедура восстановления должна быть задокументирована.
