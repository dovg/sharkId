# Юзкейзы

---

## UC-01 Авторизация

Цель: ограничить доступ к системе.

Сценарий:

1. Пользователь открывает приложение.
2. Вводит email/пароль.
3. Получает JWT-токен.
4. Получает доступ к функционалу согласно своей роли.

---

## UC-02 Создание погружения

Цель: создать DiveSession. Требуется роль editor+.

Сценарий:

1. Пользователь нажимает «Новое погружение».
2. Выбирает локацию из справочника.
3. Указывает дату/время начала и окончания.
4. Добавляет комментарий.
5. Сохраняет.

---

## UC-03 Управление локациями

Просмотр доступен всем. Добавление/редактирование/удаление — editor+.

Сценарий добавления:

1. Пользователь открывает раздел «Локации».
2. Нажимает «Добавить».
3. Заполняет страну, спот, координаты.
4. Сохраняет.

---

## UC-04 Загрузка фото

Требуется роль editor+.

Сценарий:

1. Пользователь открывает погружение.
2. Загружает пачку фото (JPEG/PNG, макс. 50 МБ).
3. Фото сохраняются в MinIO.
4. Создаются записи Photo.
5. Автоматически запускается детекция bbox и классификация.

---

## UC-05 Автоматическая идентификация

Сценарий:

1. Фото загружено.
2. ML-сервис выделяет область акулы и зону морды (shark_bbox, zone_bbox).
3. Генерирует 106-мерный эмбеддинг (HSV + LBP + spatial).
4. Выполняет поиск KNN (косинусное сходство).
5. Формирует топ-5 кандидатов с оценками.
6. Применяет глобальный порог уверенности.
7. Фото получает статус `ready_for_validation`.

---

## UC-06 Ручная аннотация фото

Требуется роль editor+.

Сценарий:

1. Пользователь открывает фото.
2. Шаг 1: рисует прямоугольник вокруг акулы (shark_bbox).
3. Шаг 2: рисует прямоугольник вокруг зоны морды (zone_bbox, в системе координат кропа).
4. Шаг 3: указывает ориентацию (face_left / face_right).
5. Подтверждает аннотацию → ML переклассифицирует с новыми bbox.

Если ML уже предзаполнил bbox (auto_detected=True), пользователь может скорректировать или принять.

---

## UC-07 Валидация привязки

Требуется роль editor+.

Сценарий:

1. Пользователь открывает очередь валидации.
2. Видит фото с bbox-оверлеями и топ-5 кандидатов (с превью).
3. Выбирает действие:
   - подтвердить кандидата,
   - выбрать другую акулу из каталога,
   - создать новую акулу,
   - оставить без привязки.
4. Система фиксирует решение, создаёт черновик Observation, обновляет статус фото на `validated`.

---

## UC-08 Создание новой акулы

Требуется роль editor+.

Сценарий:

1. Пользователь выбирает «Новая акула» в очереди валидации или напрямую.
2. Система предлагает временное имя (персонаж Гарри Поттера).
3. Пользователь подтверждает или меняет имя.
4. Создаётся запись Shark.
5. Фото привязывается; опционально — устанавливается как главное фото профиля.

---

## UC-09 Подтверждение наблюдения

Требуется роль editor+.

Сценарий:

1. Черновик Observation создаётся автоматически при валидации.
2. Пользователь открывает наблюдение, просматривает и редактирует поля.
3. Подтверждает → наблюдение становится confirmed (необратимо).

---

## UC-10 Каталог акул

Доступен всем авторизованным пользователям. Стартовая страница приложения.

Сценарий:

1. Пользователь открывает каталог.
2. Ищет по имени или фильтрует по статусу.
3. Открывает карточку акулы.
4. Видит главное фото, статистику (первое/последнее наблюдение, количество сессий и фото).

---

## UC-11 Загрузка видео

Требуется роль editor+.

Сценарий:

1. Пользователь открывает погружение.
2. Загружает видеофайл (макс. 500 МБ).
3. Видео сохраняется в MinIO.
4. В фоне ML-сервис извлекает кадры с акулами (с интервалом VIDEO_FRAME_INTERVAL, макс. 30 кадров).
5. Для каждого кадра создаётся Photo-запись и запускается классификация.
6. Страница погружения обновляется автоматически по завершении.

---

## UC-12 Просмотр журнала событий

Доступен пользователям с ролью editor+.

Сценарий:

1. Пользователь открывает раздел «Журнал событий».
2. Видит хронологический список всех изменяющих действий в системе.
3. Может фильтровать по типу и ID ресурса.
4. Каждая запись: действие, кто выполнил, когда, IP-адрес, контекст.

---

## UC-13 Управление пользователями

Доступно только администраторам.

Сценарий:

1. Администратор открывает раздел «Пользователи».
2. Видит список всех пользователей с ролями.
3. Может:
   - создать нового пользователя (email, пароль, роль),
   - изменить роль существующего пользователя,
   - сбросить пароль,
   - удалить пользователя (кроме себя).

---

## UC-14 Бэкап

Сценарий:

- Регулярный дамп PostgreSQL.
- Регулярный snapshot MinIO.
- Возможность восстановления системы.
